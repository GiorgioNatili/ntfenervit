{% extends "admin/base_site.html" %}
{% load i18n admin_static bootstrapped_goodies_tags settings_tags %}
{% block icon-detail %}<i class="icon-book"></i>{% endblock %}
{% block content_title %}Contatto{% endblock %}
{% block content_subtitle %}<h5>visualizza e modifica gli attributi del contatto selezionato</h5>{% endblock %}
{% block extrastyle %}
    <script src="https://maps.googleapis.com/maps/api/js?key={% settings_value "GOOGLE_MAP_API_KEY" %}&sensor=false&language=it"></script>
    <style>
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
        #map-canvas img {
            max-width: none;
        }
    </style>
{% endblock %}
{% block content %}
	
	<div id="modal-tables" class="modal fade" aria-hidden="true" style="display: none; width: 80%; left: 30%;">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h6 id="modal-tablesLabel">Seleziona Azienda di Appartenenza</h6>
				</div>
				<div class="modal-body nopadding">
					<!-- find me in partials/data_tables_custom -->

					
					<div id="dataTables">
						<form id="contacts_form" method="post">
							{% csrf_token %}
							<div class="table-header">
								<div class="dataTables_filter">
									<label>Cerca: <input type="text" id="txtSearchCompany" name="txtSearchCompany" value=""/> <button id="btnSearchCompanies" class="btn btn-default">Cerca</button></label>
								</div>
								<!--<div class="dataTables_length">
									<label>Righe per pagina:
										<a href="#" class="btn btn-{% if limit == 10 %}blue{% else %}default{% endif %}" onclick="rowsForPage(10)">10</a>
										<a href="#" class="btn btn-{% if limit == 25 %}blue{% else %}default{% endif %}" onclick="rowsForPage(25)">25</a>
										<a href="#" class="btn btn-{% if limit == 50 %}blue{% else %}default{% endif %}" onclick="rowsForPage(50)">50</a>
										<a href="#" class="btn btn-{% if limit == 100 %}blue{% else %}default{% endif %}" onclick="rowsForPage(100)">100</a>
									</label>
								</div>-->
							</div>
							<input type="hidden" name="limit" value="{% if limit %}{{ limit }}{% else %}10{% endif %}" />
							<input type="hidden" name="pages" value="{{ pages }}" />
							<input type="hidden" name="offset" value="{% if offset %}{{ offset }}{% else %}0{% endif %}" />
							<input type="hidden" name="clicked" value="{% if actual %}{{ actual }}{% else %}1{% endif %}" />
							<input type="hidden" name="newsearch" value=false />
							<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
						</form>
						<!--<table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">-->
						<table id="modalCompaniesTable" class="table table-normal">
							<thead>
							<tr>
								<th></th>
								<th><div>Codice</div></th>
								<th><div>Denominazione</div></th>
								<th><div>P.Iva</div></th>
								<th><div>Email</div></th>
								<th><div>Indirizzo</div></th>
								<th>&nbsp;</th>
							</tr>
							</thead>
							<tbody>
							<!--
							{% for company in companies %}
							   <tr>
								   <td><button class="btn btn-blue btnCompanySelected" onclick="btnCompanySelectedClicked('{{company.pk}}', '{{company.name|escapejs }}')" value="{{ company.pk }}"><i class="icon-signin"></i>Select</button></td>
								   <td>{{ company.company_code }}</td>
								   <td>{{ company.name }}</td>
								   <td>{{ company.vat }}</td>
								   <td>{{ company.email|default_if_none:"" }}</td>
								   <td>{{ company.street}} {{company.civic}}, {{company.city}} ({{company.province.code}})</td>
								   <td><a href="/admin/contacts/company/{{company.vat}}"><i class="icon-tasks"></i></a></td>
							   </tr>

							{% endfor %}
							-->
							</tbody>
						</table>
					</div>
					
					
				</div>
				<div class="modal-footer">
					<button class="btn btn-default" id="modalButtonClose" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	
    <div class="container-fluid padded">
        <div class="row-fluid">
            <div class="span12">

                <div class="box">
                    <!-- Navigation Tab -->
                    <div class="box-header">
                        <ul class="nav nav-tabs nav-tabs-left">
                            <li id="contactTab" class="active"><a href="#" data-toggle="tab"><i class="icon-book"></i>Contatto</a></li>
                            <li id="mapTab"><a href="#" data-toggle="tab"><i class="icon-map-marker"></i>Mappa</a></li>
                            <li id="filesTab"><a href="#" data-toggle="tab"><i class="icon-file"></i>Allegati</a></li>
                        </ul>
                        <ul class="box-toolbar">
                            <li>
                                <a href="#" id="hideDetails"><i class="icon-arrow-up"></i> Nascondi
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Contact Tab -->
                    <div class="box-content" id="contactDetails">
                        <form class="fill-up validatable" enctype="multipart/form-data" method="post" id="contact_form">
                            {% csrf_token %}
                            {% if form.errors %}
                                <div class="alert alert-error">
                                    Correggi i seguenti errori:
                                    <ul>
                                        {% for field, errors in form.errors.items %}
                                            {% for error in errors %}
                                                <li>{{ field }}: {{ error }}</li>
                                            {% endfor %}

                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            <div class="row-fluid"> <!-- contenitore form -->
                                <!-- primo tab -->
                                <div class="span6">
                                    <ul class="padded separate-sections">
                                        <li>
                                            <label>Anagrafica:</label>
                                        </li>
                                        <li class="input">
                                            <input type="text" style="text-transform:capitalize;" name="name" class="validate[required]" data-prompt-position="topLeft" placeholder="Nome" value="{{ contact.name }}"/>
                                        </li>
                                        <li class="input">
                                            <input type="text" style="text-transform:capitalize;" name="surname" class="validate[required]" data-prompt-position="topLeft" placeholder="Cognome" value="{{ contact.surname }}"/>
                                        </li>
                                        <li class="input">
                                            <label style="display: inline;margin-right: 15px">Sesso:</label>
                                            <select class="uniform" name="sex" value="{{contact.sex}}" >
                                                <option value="m" selected="selected">Maschile</option>
                                                <option value="f" >Femminile</option>
                                                <option value="n" >Neutro</option>
                                            </select>
                                        </li>
                                        <li class="input">

                                            <input id="birthdate" type="text" name="birthdate" class="validate[required]" data-prompt-position="topLeft" placeholder="Data di nascita" value="{{ contact.birthdate|date:'d/m/Y'|default_if_none:"" }}"/>
                                        </li>
                                        <li>
                                            <input type="text" id="code" name="code" class="validate[required]" data-prompt-position="topLeft" placeholder="Codice Fiscale" value="{{ contact.code|default_if_none:"" }}" disabled/>
                                        </li>
                                        <li>
                                            <input type="text" id="email" name="email" class="validate[custom[email]]" placeholder="Email" value="{{ contact.email|default_if_none:""}}"/>
                                        </li>
                                        <li>
                                            <input type="text" id="phone_number" name="phone_number" class="validate[custom[phone]]" placeholder="Telefono" value="{{ contact.phone_number|default_if_none:""}}"/>
                                        </li>

                                    </ul>
                                </div>
                                <!-- secondo tab -->
                                <div class="span6">
                                    <ul class="padded separate-sections">
                                        <li>
                                            <label>Indirizzo:</label>
                                        </li>
                                        <li>
                                            <input type="text"  name="street" class="validate[required]" data-prompt-position="topLeft" placeholder="Via" value="{{ contact.street|default_if_none:"" }}"/>
                                        </li>
                                        <li>
                                            <input type="text"  name="civic" class="validate[required,min[6]]" data-prompt-position="topLeft" placeholder="Civico" value="{{ contact.civic|default_if_none:"" }}"/>
                                        </li>
                                        <li>
                                            <input type="text"  name="zip" class="validate[required,min[4]]" data-prompt-position="topLeft" placeholder="CAP" value="{{ contact.zip|default_if_none:"" }}"/>
                                        </li>
                                        <li>
                                            <input type="text"  style="text-transform:capitalize;" name="city" class="validate[required]" data-prompt-position="topLeft" placeholder="Comune" value="{{ contact.city|default_if_none:"" }}"/>
                                        </li>
                                        <li>
                                            <label>Provincia:</label>
                                            <select class="chzn-select" name="province" >
                                                {% for prov in provinces %}

                                                    <option value="{{ prov.id }}" {% if prov.id == contact.province.id %} selected="selected"{% endif %}>{{ prov }}</option>
                                                {% endfor %}
                                            </select>
                                        </li>
                                    </ul>
                                </div>
                            </div> <!-- contenitore prima parte -->
                            <div class="row-fluid"> <!-- contenitore seconda parte -->
                                <div class="span6">
                                    <ul class="padded separate-sections">
                                        <li>
                                            <label>Lavoro:</label>
                                        </li>
                                        <li>
                                            <label>Azienda di appartenenza:</label>
                                            <!--<select class="chzn-select" name="company" >
                                                <option value="" selected="selected">Nessuna</option>
                                                {% for company in companies %}
                                                    <option value="{{ company.name }}" {% if company.name == form.instance.company.name %} selected="selected"{% endif %}>{{ company }}</option>
                                                {% endfor  %}
                                            </select> -->
											
											<div class="row-fluid">
												<div class="span9">
													<input type="text" readonly name="company_selected_name" placeholder="Azienda di Appartenenza" value="{{ contact.company.name|default_if_none:'Nessuna' }}"/>
													<input type="hidden" name="company" value="{{ company.pk }}" />
												</div>
												<div class="span3">
													<a data-toggle="modal" href="#modal-tables" class="btn btn-blue"><i class="icon-table"></i> Ricerca</a>
												</div>
											</div>
                                        </li>
                                        <label>Settore:</label>
                                        <select id="sector" class="chzn-select" name="sector" >

                                            {% for s in sectors %}
                                                <option value="{{ s.id }}" {% if s.id == sector.id %} selected="selected"{% endif %}>{{ s }}</option>
                                            {% endfor  %}
                                        </select>
                                        <li id="workLi">
                                            <label>Professione:</label>
                                            <select id="work" class="chzn-select" name="work" >
                                                {% for w in works %}
                                                    <option value="{{ w.id }}" {% if w.id == contact.work.id %} selected="selected"{% endif %}>{{ w }}</option>
                                                {% endfor  %}
                                            </select>
                                        </li>
                                        <li>
                                            <label>Rank di importanza aziendale</label>
                                            <input type="text"  name="company_ranking" class="validate[required,custom[integer]" data-prompt-position="topLeft" placeholder="Rank di importanza aziendale" value="{{ contact.company_ranking }}"/>

                                        </li>
                                        <li>
                                            <label>Rank di partecipazione</label>
                                            <input type="text"  name="participation_ranking" class="validate[required,custom[integer]" data-prompt-position="topLeft" placeholder="Rank di partecipazione" value="{{ contact.participation_ranking }}"/>

                                        </li>
                                    </ul>
                                </div>
                                <div class="span6">
                                    <ul class="padded separate-sections">
                                        <li>
                                            <label>Categoria contatto:</label>
                                        </li>
                                        <li>
                                            <label>Divisione:</label>
                                            <select id="division" class="chzn-select" name="division" >

                                                {% for division in divisions %}
                                                    <option value="{{ division.id }}" {% if division.id == ana_division.id %} selected="selected"{% endif %}>{{ division }}</option>
                                                {% endfor  %}
                                            </select>
                                        </li>
                                        <li id="subdivisionLi">
                                            <label>Sottocategoria:</label>
                                            <select id="subdivision" class="chzn-select" name="anagrafic_subdivision" >
                                                {% for subdivision in subdivisions %}
                                                    <option value="{{ subdivision.id }}" {% if subdivision.id == contact.anagrafic_subdivision.all.0.id %} selected="selected"{% endif %}>{{ subdivision }}</option>
                                                {% endfor  %}
                                            </select>
                                        </li>
                                        <li>
                                            <label style="display: inline;margin-right: 15px">Tipologia <i>(Normale o Consulente esterno per eventi)</i>:</label>
                                            <select id="contact_type" class="uniform" name="type" >
                                                <option value="N" {% if contact.type == 'N' %}selected="selected"{% endif %}>Normale</option>
                                                <option value="C" {% if contact.type == 'C' %}selected="selected"{% endif %}>Consulente (login non sarà abilitato)</option>
                                            </select>
                                        </li>
                                        <li id="list_its">
                                            <label>ITS:</label>
                                            <select class="chzn-select" id="its" name="its">
                                                <option>---</option>

                                                {% for pos in its_users %}
                                                    <option value="{{ pos.id }}" {% if pos.id == itsrel.its.id %}
                                                            selected="selected"{% endif %}>{{ pos.first_name }} {{ pos.last_name }}
                                                        {% if pos.email %}({{ pos.email }}){% endif %}
                                                    </option>
                                                {% endfor %}

                                            </select>
                                        </li>


                                    </ul>
                                </div>
                            </div><!-- contenitore seconda parte -->
                            <div class="row-fluid">
                                <div class="span6">
                                    <ul class="padded separate-sections">

                                        {% if contact.owner %}
                                            <li>
                                                <label>Utente registrato</label>
                                                <a style="font-weight: bold;" href="/admin/backend/utenti/details/{{contact.owner.id}}">{{ contact.owner }}</a>
                                            </li>
                                        {% endif %}
                                        <li>
                                            <label style="display: inline;margin-right: 15px">Stato:</label>
                                            <select class="uniform" name="status" >
                                                <option value="I" {% if contact.status == 'I' %}selected="selected"{% endif %}>Inerte</option>
                                                <option value="A" {% if contact.status == 'A' %}selected="selected"{% endif %}>Attivo</option>
                                                <option value="N" {% if contact.status == 'N' %}selected="selected"{% endif %}>Non Attivo</option>
                                                <option value="C" {% if contact.status == 'C' %}selected="selected"{% endif %}>Cancellato</option>
                                                <option value="D" {% if contact.status == 'D' %}selected="selected"{% endif %}>Non Interessato</option>
                                            </select>
                                        </li>

                                        <li>
                                            <label style="display: inline;margin-right: 15px">Consenso privacy:</label>
                                            <select class="uniform" name="privacy_consensus" >
                                                <option value="true" {% if contact.privacy_consensus == True %}selected="selected"{% endif %}>Fornito</option>
                                                <option value="false"{% if contact.privacy_consensus == False %}selected="selected"{% endif %} >Non fornito</option>

                                            </select>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                            <div class="form-actions">
                                <input type="hidden" id="code" name="code" value="{{ contact.code|default_if_none:"" }}" />
                                <button type="button" onclick="btnSaveClicked();" name="_save" class="btn btn-blue">Salva</button>
                                <button type="button" name="_addanother" class="btn btn-green">Salva e aggiungi un altro</button>
                            </div>
                        </form>
                    </div>

                    <!-- Map Tab -->
                    <div class="box-content" id="mapDetails" style="display: none;">
                        <div id="map-canvas"></div>
                        <div class="row-fluid">
                            <div class="span6">
                                <form name="findRoute" action="">
                                    <div class="row-fluid"> <!-- contenitore form -->
                                        <!-- primo tab -->
                                        <div class="span6">
                                            <ul class="padded separate-sections">
                                                <li><label><span style="font-weight: bold;">Calcola Percorso</span></label></li>
                                                <li>
                                                    <label>Indirizzo di Partenza</label>
                                                    <input type="text" name="partenza" id="partenza" placeholder="Indirizzo di partenza" />

                                                </li>
                                                <li>
                                                    <label>Indirizzo di Arrivo</label>
                                                    <input type="text" name="arrivo" id="arrivo" placeholder="Indirizzo di arrivo" value="{{ contact.street }} {{ contact.civic }} {{ contact.city }}" />

                                                </li>
                                                <li>
                                                    <button name="calcola" id="calcola" class="btn btn-blue">Calcola</button>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="span6">
                                <div id="route" style="background-color: #fff;padding: 5px;border: 1px solid #999;height: 100%;float: right;overflow: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Files Tab -->
                    <div class="box-content" id="fileDetails" style="display: none;">
                        <div class="container-fluid padded">
                            <div class="row-fluid">
                                <div class="span12">
                                    <div class="box">
                                        <div class="box-header">
                                            <span class="title">Certificati</span>
                                            <ul class="object-tools form-inline pull-right inline">
                                                <li>
                                                    <button id="addCertFile" class="btn btn-blue">
                                                        <i class="icon-plus icon-white"></i> Aggiungi
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="box-content">
                                            <div id="certFileTable">
                                                <table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">
                                                    <thead>
                                                    <tr>
                                                        <th><div>Id</div></th>
                                                        <th><div>Titolo</div></th>
                                                        <th><div>Scadenza</div></th>
                                                        <th><div>File</div></th>
                                                        <th><div>Data</div></th>
                                                        <th>&nbsp;</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for certfile in certfiles %}
                                                        <tr>
                                                            <td>{{ certfile.id }}</td>
                                                            <td>{{ certfile.file.title }}</td>
                                                            <td>{{ certfile.expiry|date:"d-m-Y" }}</td>
                                                            <td><a href="{{ MEDIA_URL }}{{ certfile.file.file_ref }}" target="_blank">{{ certfile.file.file_basename }}</a></td>
                                                            <td>{{ certfile.date_created|date:'d-m-Y H:i:s' }}</td>

                                                            <td><a href="/admin/cabinet/{{ contact.code }}/cert/{{ certfile.id }}?hash=filesTab"><i class="icon-tasks"></i></a></td>
                                                        </tr>

                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- end "container-fluid padded" for Certificati -->

                        <div class="container-fluid padded">
                            <div class="row-fluid">
                                <div class="span12">
                                    <div class="box">
                                        <div class="box-header">
                                            <span class="title">Files</span>
                                            <ul class="object-tools form-inline pull-right inline">
                                                <li>
                                                    <button id="addRefFile" class="btn btn-blue">
                                                        <i class="icon-plus icon-white"></i> Aggiungi
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="box-content">
                                            <div id="refFileTable">
                                                <table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">
                                                    <thead>
                                                    <tr>
                                                        <th><div>Id</div></th>
                                                        <th><div>Titolo</div></th>
                                                        <th><div>File</div></th>
                                                        <th><div>Data</div></th>
                                                        <th>&nbsp;</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for refile in refiles %}
                                                        <tr>
                                                            <td>{{ refile.id }}</td>
                                                            <td>{{ refile.file.title }}</td>
                                                            <td><a href="{{ MEDIA_URL }}{{ refile.file.file_ref }}" target="_blank">{{ refile.file.file_basename }}</a></td>
                                                            <td>{{ refile.date_created|date:'d-m-Y H:i:s' }}</td>

                                                            <td><a href="/admin/cabinet/{{ contact.code }}/ref/{{ refile.id }}?hash=filesTab"><i class="icon-tasks"></i></a></td>
                                                        </tr>

                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- end "container-fluid padded" for Files -->

                    </div>
                </div> <!-- end box -->
            </div> <!-- span 12 -->
        </div><!-- row fluid -->
    </div>
    <div class="container-fluid padded" id="history">
        <div class="box">
            <div class="box-header">
                <span class="title">Storia</span>
            </div>

            <div class="row-fluid" style="margin-top: 20px;">
                <div class="span6">
                    <div class="box">
                        <div class="box-header">
                            <span class="title">Destinatario newsletter</span>
                        </div>
                        <div class="box-content">
                            <div id="newsletterDataTables">
                                <table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">
                                    <thead>
                                    <tr>
                                        <th>
                                            <div>Id</div>
                                        </th>
                                        <th>
                                            <div>Denominazione</div>
                                        </th>
                                        <th>
                                            <div>Campagna</div>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for nl in newsletter_target %}
                                        <tr>
                                            <td>{{ nl.newsletter.id }}</td>
                                            <td>{{ nl.newsletter.name }}</td>
                                            <td>{{ nl.newsletter.campaign }}</td>

                                        </tr>

                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span6">
                    <div class="box">
                        <div class="box-header">
                            <span class="title">Eventi</span>
                        </div>
                        <div class="box-content">
                            <div id="dataTables">
                                <table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">
                                    <thead>
                                    <tr>
                                        <th>
                                            <div>Id</div>
                                        </th>
                                        <th>
                                            <div>Data</div>
                                        </th>
                                        <th>
                                            <div>Descrizione</div>
                                        </th>
                                        <th>
                                            <div>Attributo</div>
                                        </th>
                                        <th>
                                            <div>Presente</div>
                                        </th>

                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for event in event_signup %}
                                        <tr>
                                            <td>{{ event.event.id }}</td>
                                            <td>{{ event.event.date|date:"d-m-Y" }}</td>
                                            <td>{% if event.event.title %}{{ event.event.title }}{% else %}{{ event.event.description }}{% endif %}</td>
                                            <td>{% if event.staff %}
                                                Staff
                                            {% elif event.omaggio %}
                                                Omaggio {% if event.note %}({{ event.note }}){% endif %}
                                            {% elif event.pagante %}
                                                Pagante
                                            {% endif %}
                                            </td>
                                            <td>{{ event.presence|yesno:"Si,No"  }}</td>
                                        </tr>

                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span6">
                    <div class="box">
                        <div class="box-header">
                          <span class="title">Sottomissioni questionari</span>
                        </div>
                        <div class="box-content">
                          <div id="submissionDataTables">
                              <table cellpadding="0" cellspacing="0" border="0" class="dTable2 responsive">
                                  <thead>
                                      <tr>
                                          <th>
                                              <div>Id</div>
                                          </th>
                                          <th>
                                              <div>Questionario</div>
                                          </th>
                                          <th>
                                              <div>Risposto il</div>
                                          </th>
                                          <th>
                                              <div>Punteggio</div>
                                          </th>
                                          <th>
                                              <div>&nbsp;</div>
                                          </th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                  {% for nl in submissions %}
                                      <tr>
                                          <td>{{ nl.survey.id }}</td>
                                          <td>{{ nl.survey.title }}</td>
                                          <td>{{ nl.submitted_at|date:"d-m-Y H:i" }}</td>
                                          <td>{{ nl.score }} / {{ nl.total_score }}</td>
                                          <td><a href="/admin/survey/report/details/{{ nl.id }}"><i
                                                  class="icon-tasks"></i></a></td>
                                      </tr>

                                  {% endfor %}
                                  </tbody>
                              </table>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
	
		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		
		function btnSaveClicked(){
			
			console.log("BtnSaveClicked");

			//Create OPTION
			/*alert(1);
			var value = document.forms["contact_form"].elements["company_hidden"].value;
			alert(value);
			var option = new Option(value, value);
			alert(option.value);
			document.forms["contact_form"].elements["company"].add(option);	
			document.forms["contact_form"].elements["company"].value = value;*/
			document.forms["contact_form"].submit();
			
		}
		
		function btnCompanySelectedClicked(pk, name){
			console.log("btnCompanySelected is working!"); // sanity check
			console.log("Pk: " + pk + ", Name: " + name);
			
			//Set hidden company value
			document.forms["contact_form"].elements["company"].value = pk;
			document.forms["contact_form"].elements["company_selected_name"].value = name;
			
			//Close Modal
			document.getElementById('modalButtonClose').click();
			
		}

        $(function() {

            $("#mapDetails").width($("#contactDetails").width());
            $("#mapDetails").height($("#contactDetails").height()/2);
            $("#map-canvas").width($("#contactDetails").width());
            $("#map-canvas").height($("#contactDetails").height()/2);
			
			$("#btnSearchCompanies").on("click",function(e){
				e.preventDefault();
				console.log("search_companies post is working!"); // sanity check
				$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
							xhr.setRequestHeader("X-CSRFToken", document.forms["contacts_form"].elements["csrfmiddlewaretoken"].value);
						}
					}
				});
				$.ajax({
					url : "../search_companies/", // the endpoint
					type : "POST", // http method
					data : { 
						text : document.forms["contacts_form"].elements["txtSearchCompany"].value,
						limit : document.forms["contacts_form"].elements["limit"].value,
						offset : document.forms["contacts_form"].elements["offset"].value,
						clicked : document.forms["contacts_form"].elements["clicked"].value,
						csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
						newsearch : true
					}, // data sent with the post request

					// handle a successful response
					success : function(json) {
						console.log(json); // log the returned json to the console
						console.log("success"); // another sanity check
						
						/*
						<tr>
							<td><button class="btn btn-blue btnCompanySelected" onclick="btnCompanySelectedClicked('{{company.pk}}', '{{company.name|escapejs }}')" value="{{ company.pk }}"><i class="icon-signin"></i>Select</button></td>
							<td>{{ company.company_code }}</td>
							<td>{{ company.name }}</td>
							<td>{{ company.vat }}</td>
							<td>{{ company.email|default_if_none:"" }}</td>
							<td>{{ company.street}} {{company.civic}}, {{company.city}} ({{company.province.code}})</td>
							<td><a href="/admin/contacts/company/{{company.vat}}"><i class="icon-tasks"></i></a></td>
						</tr>
						*/
					   
						//Remove all rows from Table
						$("#modalCompaniesTable tbody").remove();
						
						//Get Table
						var table = document.getElementById("modalCompaniesTable");

						var companies = JSON.parse(json.companies); 
						console.log(companies[0]);
						
						var company;
						for(company in companies){
							console.log("Company: " + companies[company]);
							
							//Create Row and Add To Table
							var row = table.insertRow();
							//Create cell
							var cell_0 = row.insertCell(0);
							var cell_1 = row.insertCell(1);
							var cell_2 = row.insertCell(2);
							var cell_3 = row.insertCell(3);
							var cell_4 = row.insertCell(4);
							var cell_5 = row.insertCell(5);
							var cell_6 = row.insertCell(6);
							//Valorize cell
							cell_0.innerHTML = '<button class="btn btn-blue btnCompanySelected" onclick="btnCompanySelectedClicked(\''+companies[company].pk+'\', \''+companies[company].fields.name+'\')" value="'+companies[company].pk+'"><i class="icon-signin"></i>Select</button>';
							cell_1.innerHTML = companies[company].fields.company_code;
							cell_2.innerHTML = companies[company].fields.name;
							cell_3.innerHTML = companies[company].pk;
							cell_4.innerHTML = (companies[company].fields.email) ? companies[company].fields.email : "";
							cell_5.innerHTML = companies[company].fields.street + " " + companies[company].fields.civic + ", " + companies[company].fields.city + " " + companies[company].fields.province.code;
							cell_6.innerHTML = '<a href="/admin/contacts/company/' + companies[company].pk + '"><i class="icon-tasks"></i></a>';
						}
					   
					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
					}
				});
			});

            var mapOptions = {
                center: new google.maps.LatLng( 45.465454, 9.186516),
                zoom: 9,
                mapTypeControl: true,
                mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                navigationControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);

            var city="{{ contact.city }}";
            var address="{{ contact.street }}, {{ contact.city }} Italy";

            var directionsService = new google.maps.DirectionsService();
            var directionsDisplay= new google.maps.DirectionsRenderer();;
            directionsDisplay.setMap(map);
            directionsDisplay.setPanel(document.getElementById('route'));

            $("#calcola").on("click",function(e){
                e.preventDefault();
                if(address!="" && city!=""){
                    if($("#partenza").val()!="" && $("#arrivo").val()!=""){
                        getRoute();
                    }else{
                        alert("Inserire indirizzo di partenza e arrivo!!!");
                    }
                }else{
                    alert("Non è possibile calcolare il percorso: Non esiste l'indirizzo del contatto!!!");
                }
            });

            function getRoute(){
                var request = {
                    origin:$("#partenza").val(),
                    destination:$("#arrivo").val(),
                    travelMode: google.maps.TravelMode.DRIVING
                };
                directionsService.route(request, function(result, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(result);
                    }
                });
            }

            $("#birthdate" ).datepicker({"language":"it","format":"dd/mm/yyyy"});

            $("#sector").on("change",function(){
                console.log("SELECTED: "+$("#sector").val());
                var sector = $("#sector").val();
                if(sector == -1){
                    $("#work option").remove();
                    $("#work").html('<option value="-1"> Selezionare prima il Settore </option>');
                }
                $.getJSON(
                        "/admin/contacts/rest/work",
                        {
                            sector : sector
                        },
                        function(data){
                            $("#work").prop('disabled', false);
                            $("#work option").remove();
                            $("#workLi").find("span").text("---");
                            var html='';
                            $.each(data,function(i,opt){
                                html+="<option value='"+opt.pk+"'";
                                if(i==0){
                                    html+="selected='selected'";
                                }
                                html+=">"+opt.fields.name+"</opt>";
                            });
                            $("#work").append(html);

                        }
                );

            });

            $("#division").on("change",function(){
                var sector = $("#division").val();
                if(sector == -1){
                    $("#subdivision option").remove();
                    $("#subdivision").html('<option value="-1"> Selezionare prima la Divisione </option>');
                }
                $.getJSON(
                        "/admin/contacts/rest/subdivision",
                        {
                            division : sector
                        },
                        function(data){
                            $("#subdivision").prop('disabled', false);
                            $("#subdivision option").remove();
                            $("#subdivisionLi").find("span").text("---");
                            var html='';
                            $.each(data,function(i,opt){
                                html+="<option value='"+opt.pk+"'";
                                if(i==0){
                                    html+="selected='selected'";
                                }
                                html+=">"+opt.fields.name+"</opt>";
                            });
                            $("#subdivision").append(html);

                        }
                );

            });

            $("#code").on("keyup",function(e){
                $("#code").val($("#code").val().toUpperCase());
            });

            $("#email").on("keyup",function(e){
                $("#email").val($("#email").val().toLowerCase());
            });

            $(".dTable2").dataTable({
                bJQueryUI: !1,
                bAutoWidth: !1,
                sPaginationType: "full_numbers",
                sDom: '<"table-header"fl>t<"table-footer"ip>',
                "oLanguage": {
                    "sSearch": "Cerca",
                    "sLengthMenu": "Mostra _MENU_ righe per pagina",
                    "sZeroRecords": "Nessun risultato trovato",
                    "sInfo": "Risultati da _START_ a _END_ di _TOTAL_ ",
                    "sInfoEmpty": "Mostrati da 0 a 0 di 0 records",
                    "sInfoFiltered": "(filtrati da _MAX_ records totali)",
                    "oPaginate": {
                        "sFirst": "Primo",
                        "sLast": "Ultimo",
                        "sNext": "Prossimo",
                        "sPrevious": "Precedente"

                    }
                }
            });

            $("#hideDetails").on("click",function(e){
                e.preventDefault();
                if($("#contactDetails").is(":visible")){
                    $("#contactDetails").hide();
                    $("#hideDetails").html('<i class="icon-arrow-down"></i> Mostra')
                }else{
                    $("#contactDetails").show();
                    $("#hideDetails").html('<i class="icon-arrow-up"></i> Nascondi')
                }
            });

            /*
             Show or hide ITS dropdown
             */
            function showHideConsultantITS() {
                var contact_type = $("#contact_type option:selected").val();
                if (contact_type === "C") {
                    $("#list_its").show();
                } else {
                    $("#list_its").hide();
                }
            }
            $("#contact_type").on("change", showHideConsultantITS);

            /*
             Files Section
            */
            $("#addCertFile, #addRefFile").on("click", function (e) {
                var buttonName = this.id,
                    url;

                if (buttonName === "addCertFile") {
                    url = "/admin/cabinet/{{ contact.code }}/cert/add";
                } else {
                    url = "/admin/cabinet/{{ contact.code }}/ref/add";
                }

                if (window.location.hash) {
                    var hash = window.location.hash.substring(1);
                    url += "?hash=" + hash;
                }

                window.location.href = url;

            });

            /*
             TABS Management: set form status based on active tab
             */
            var tabs = {
                "contactTab": "contactDetails",
                "mapTab": "mapDetails",
                "filesTab": "fileDetails"
            };
            function setFormStatus(activeTab) {
                // Manage tabs display
                $.each(tabs, function (key, value) {
                    if (key === activeTab) {
                        $('#' + key).addClass("active");
                        $('#' + value).show();
                    } else {
                        $('#' + key).removeClass("active");
                        $('#' + value).hide();
                    }
                });

                // Set the hash
                window.location.hash = activeTab;

                // Manage elements that should only show when contactTab is selected
                if (activeTab === 'contactTab') {
                    $("#hideDetails").show();
                    $("#history").show();
                } else {
                    $("#hideDetails").hide();
                    $("#history").hide();
                }

                // Special processing for maps tab
                if (activeTab === 'mapTab') {
                    displayMap();
                }
            }
            function displayMap() {
                if(address!="" && city!=""){
                    geocoder = new google.maps.Geocoder();
                    geocoder.geocode({
                        'address': address
                    }, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            var marker = new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location
                            });
                            map.panTo(marker.getPosition());
                            map.setZoom(15);
                        }
                    });
                }else{
                    map.panTo(new google.maps.LatLng( 45.465454, 9.186516));
                    map.setZoom(9);
                }
                google.maps.event.trigger(map, 'resize');
            }

            $("#contactTab, #mapTab, #filesTab").on("click", function (e) {
                setFormStatus(this.id);
            });

            /*
            When Document is ready, set the form status according to url hash
             */

            $(document).on("ready",function(){
                var hash = "contactTab";
                if (window.location.hash) {
                    var h = window.location.hash.substring(1);
                    // Only update hash variable if hash is valid
                    if (h in tabs) {
                        hash = h;
                    } else {
                        // Invalid hash given, reset to default
                        window.location.hash = hash;
                    }
                } else {
                    // No hash given.  Set default.
                    window.location.hash = hash;
                }

                setFormStatus(hash);

                google.maps.visualRefresh = true;

                showHideConsultantITS();
            });

        });
    </script>
{% endblock %}